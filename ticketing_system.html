<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taconmadre - Enhanced Order Ticketing System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 15px;
        }

        .google-sheets-setup {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .google-sheets-setup input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            width: 300px;
            font-size: 14px;
        }

        .google-sheets-setup input:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .filters {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: #555;
        }

        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        .status-indicator.connecting {
            background: #ffc107;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 150px;
            flex: 1;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card h3 {
            font-size: 2em;
            color: #ff6b35;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #666;
            font-weight: 600;
        }

        .stat-card.new-orders {
            border-left: 4px solid #28a745;
        }

        .stat-card.new-orders h3 {
            color: #28a745;
        }

        .tickets-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            max-height: calc(100vh - 400px);
            overflow-y: auto;
            padding-right: 10px;
        }

        .ticket {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            overflow: hidden;
            transition: all 0.3s ease;
            border-left: 5px solid #ff6b35;
            position: relative;
        }

        .ticket:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.2);
        }

        .ticket.completed {
            border-left-color: #28a745;
            opacity: 0.7;
        }

        .ticket.in-progress {
            border-left-color: #ffc107;
        }

        .ticket.new-order {
            animation: newOrderGlow 3s ease-in-out;
            border-left-color: #28a745;
            border-left-width: 8px;
        }

        @keyframes newOrderGlow {
            0%, 100% { box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
            50% { box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5); }
        }

        .ticket-header {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 15px;
            position: relative;
        }

        .ticket.completed .ticket-header {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .ticket.in-progress .ticket-header {
            background: linear-gradient(135deg, #ffc107, #ffed4e);
            color: #333;
        }

        .order-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .order-id {
            font-size: 1.4em;
            font-weight: bold;
        }

        .order-total {
            font-size: 1.3em;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
        }

        .customer-info h3 {
            font-size: 1.1em;
            margin-bottom: 4px;
        }

        .customer-details {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .order-type-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.3);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .order-type-badge.vendor {
            background: rgba(255,193,7,0.8);
            color: #333;
        }

        .order-type-badge.customer {
            background: rgba(40,167,69,0.8);
            color: white;
        }

        .ticket-body {
            padding: 20px;
        }

        .order-items {
            margin-bottom: 15px;
        }

        .order-items h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1em;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 5px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.9em;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #ff6b35;
        }

        .item.combo {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(247, 147, 30, 0.1));
            border-left-color: #ff6b35;
            font-weight: 600;
        }

        .item-name {
            font-weight: 500;
            color: #333;
        }

        .item-qty {
            background: #ff6b35;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .pickup-info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .pickup-info h4 {
            color: #1976d2;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .pickup-time {
            font-weight: bold;
            color: #333;
        }

        .ticket-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .btn-start {
            background: linear-gradient(135deg, #ffc107, #ffed4e);
            color: #333;
        }

        .btn-start:hover {
            background: linear-gradient(135deg, #ffed4e, #ffc107);
            transform: translateY(-2px);
        }

        .btn-complete {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-complete:hover {
            background: linear-gradient(135deg, #20c997, #28a745);
            transform: translateY(-2px);
        }

        .btn-reset {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }

        .btn-reset:hover {
            background: linear-gradient(135deg, #495057, #6c757d);
            transform: translateY(-2px);
        }

        .btn-connect {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-connect:hover {
            background: linear-gradient(135deg, #20c997, #28a745);
            transform: translateY(-2px);
        }

        .no-orders {
            text-align: center;
            color: white;
            font-size: 1.2em;
            margin-top: 50px;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            margin-top: 50px;
        }

        .timestamp {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            z-index: 1000;
            font-weight: bold;
            font-size: 16px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .auto-refresh-status {
            font-size: 12px;
            color: #666;
            margin-left: 10px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .google-sheets-setup {
                justify-content: center;
                flex-direction: column;
            }

            .google-sheets-setup input {
                width: 100%;
            }

            .filters {
                justify-content: center;
            }

            .tickets-container {
                grid-template-columns: 1fr;
                max-height: none;
            }

            .stats {
                flex-direction: column;
            }

            .items-grid {
                grid-template-columns: 1fr;
            }

            .ticket-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåÆ Taconmadre</h1>
        <p>Enhanced Order Ticketing System</p>
    </div>

    <div class="controls">
        <div class="google-sheets-setup">
            <input type="text" id="sheet-id" placeholder="Google Sheet ID" value="15adJePTeurwG3foqB7jApzXhPHAska3ogoZs9L1TuVU">
            <button class="btn-connect" onclick="connectGoogleSheets()">Connect Live Feed</button>
            <div class="connection-status">
                <div class="status-indicator" id="status-indicator"></div>
                <span id="connection-status">Not connected</span>
                <span class="auto-refresh-status" id="refresh-status"></span>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>Status:</label>
                <select id="status-filter">
                    <option value="all">All Orders</option>
                    <option value="pending">Pending</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Search:</label>
                <input type="text" id="search-filter" placeholder="Customer name, Order ID...">
            </div>

            <div class="filter-group">
                <button class="btn btn-reset" onclick="resetAllOrders()" style="flex: none; padding: 8px 16px;">Reset All</button>
            </div>
        </div>
    </div>

    <div class="stats">
        <div class="stat-card">
            <h3 id="total-orders">0</h3>
            <p>Total Orders</p>
        </div>
        <div class="stat-card">
            <h3 id="pending-orders">0</h3>
            <p>Pending</p>
        </div>
        <div class="stat-card">
            <h3 id="in-progress-orders">0</h3>
            <p>In Progress</p>
        </div>
        <div class="stat-card">
            <h3 id="completed-orders">0</h3>
            <p>Completed</p>
        </div>
        <div class="stat-card">
            <h3 id="total-revenue">$0.00</h3>
            <p>Total Revenue</p>
        </div>
        <div class="stat-card new-orders">
            <h3 id="new-orders-count">0</h3>
            <p>New Orders</p>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        Loading orders...
    </div>

    <div id="no-orders" class="no-orders" style="display: block;">
        Click "Connect Live Feed" to load your Google Sheet orders
    </div>

    <div id="tickets-container" class="tickets-container" style="display: none;">
        <!-- Tickets will be dynamically generated here -->
    </div>

    <!-- Notification container -->
    <div id="notification" class="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Global variables
        let orders = [];
        let orderStatuses = {};
        let googleSheetId = '';
        let isConnectedToSheets = false;
        let refreshInterval = null;
        let lastOrderCount = 0;
        let newOrderIds = new Set();
        const GOOGLE_API_KEY = 'AIzaSyAB9L3cUszgkjMFAOOjIwu5KhgqjsPgkBo';

        // Audio notification
        let notificationSound = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            document.getElementById('status-filter').addEventListener('change', filterOrders);
            document.getElementById('search-filter').addEventListener('keyup', filterOrders);
            
            // Initialize notification sound
            try {
                notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjuW3PTEcycEK4De8NiKPAcVZLfhyJo6CyJ+z+yONycEKn/N7tyKOQgXZLfktZE9CyF+z+uONygEKX/M7dqJPAcVZLfkupA9CyJ/0OqONycEKoPU/aJPCwMZcL3o26JdGQk9j9XzwXMrBSV9zu+TOhAbf8s9x2xH0c7d6S2LJQo6f9P2w3Q0fSwLEn/M7dsH0c7d7U5PiS7U5s12WChR3p5szWgYQQYKVE1rURs2a9w2Rn/0JFbsWiT5QSJhGBx5R/8vW0w6');
            } catch (e) {
                console.log('Audio notification not available');
            }
            
            console.log('Enhanced Taconmadre Ticketing System Loaded');
        });

        // Google Sheets API integration
        async function connectGoogleSheets() {
            const sheetId = document.getElementById('sheet-id').value.trim();
            if (!sheetId) {
                showNotification('Please enter a Google Sheet ID', 'error');
                return;
            }

            googleSheetId = sheetId;
            updateConnectionStatus('connecting', 'Connecting...');

            try {
                await fetchOrdersFromSheets();
                isConnectedToSheets = true;
                updateConnectionStatus('connected', 'üü¢ Live Connected');
                
                // Start auto-refresh every 5 seconds for real-time updates
                if (refreshInterval) clearInterval(refreshInterval);
                refreshInterval = setInterval(fetchOrdersFromSheets, 5000);
                
                document.getElementById('refresh-status').textContent = 'Auto-refresh: 5s';
                showNotification('Successfully connected to Google Sheets! Real-time updates enabled.', 'success');
            } catch (error) {
                console.error('Connection failed:', error);
                updateConnectionStatus('error', 'üî¥ Connection Failed');
                showNotification('Failed to connect to Google Sheets. Please check the Sheet ID.', 'error');
            }
        }

        // Update connection status
        function updateConnectionStatus(status, text) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('connection-status');
            
            indicator.className = `status-indicator ${status}`;
            statusText.textContent = text;
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Fetch orders from Google Sheets with enhanced error handling
        async function fetchOrdersFromSheets() {
            if (!googleSheetId) return;

            try {
                const range = 'Orders!A:P';
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${googleSheetId}/values/${range}?key=${GOOGLE_API_KEY}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const rows = data.values || [];
                
                if (rows.length < 2) {
                    throw new Error('No data found in the sheet');
                }

                // Parse orders (skip header row)
                const newOrders = parseOrdersFromSheets(rows.slice(1));
                const previousOrderCount = orders.length;
                
                // Detect new orders
                if (newOrders.length > previousOrderCount && previousOrderCount > 0) {
                    const newOrderCount = newOrders.length - previousOrderCount;
                    detectNewOrders(newOrders, orders);
                    showNewOrderNotification(newOrderCount);
                    playNotificationSound();
                }

                orders = newOrders;
                renderTickets();
                updateStats();

                // Update connection status
                if (isConnectedToSheets) {
                    const now = new Date().toLocaleTimeString();
                    updateConnectionStatus('connected', `üü¢ Live Connected (${now})`);
                }

            } catch (error) {
                console.error('Error fetching from Google Sheets:', error);
                if (isConnectedToSheets) {
                    updateConnectionStatus('error', 'üü° Connection Error');
                }
            }
        }

        // Detect new orders and mark them
        function detectNewOrders(newOrders, oldOrders) {
            const oldOrderIds = new Set(oldOrders.map(order => order.orderId));
            
            newOrders.forEach(order => {
                if (!oldOrderIds.has(order.orderId)) {
                    newOrderIds.add(order.orderId);
                    // Remove from new orders after 30 seconds
                    setTimeout(() => {
                        newOrderIds.delete(order.orderId);
                        renderTickets();
                    }, 30000);
                }
            });
        }

        // Play notification sound
        function playNotificationSound() {
            if (notificationSound) {
                try {
                    notificationSound.currentTime = 0;
                    notificationSound.play().catch(e => console.log('Could not play sound'));
                } catch (e) {
                    console.log('Sound notification failed');
                }
            }
        }

        // Parse orders from Google Sheets data
        function parseOrdersFromSheets(data) {
            return data
                .filter(row => row[0] && row[1])
                .map(row => ({
                    timestamp: row[0],
                    orderId: row[1],
                    customer: row[2] || 'Unknown',
                    phone: row[3] || 'N/A',
                    email: row[4] || '',
                    pickupTime: row[5] || 'ASAP',
                    items: {
                        chicharron: parseInt(row[6]) || 0,
                        frijol: parseInt(row[7]) || 0,
                        papa: parseInt(row[8]) || 0,
                        combo: parseInt(row[9]) || 0,
                        water: parseInt(row[10]) || 0,
                        miniSoda: parseInt(row[11]) || 0,
                        seltzer: parseInt(row[12]) || 0,
                        gatorade: parseInt(row[13]) || 0
                    },
                    total: row[14] || '$0.00',
                    completedInSheet: row[15] === 'TRUE' || row[15] === true || row[15] === '1',
                    orderType: determineOrderType(row[2], row[4]) // Determine if vendor or customer order
                }))
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // Determine order type based on customer info
        function determineOrderType(customerName, email) {
            // If no email or email is empty, it's likely a vendor order
            if (!email || email.trim() === '') {
                return 'vendor';
            }
            // If customer name is "Vendor Order", it's definitely a vendor order
            if (customerName && customerName.toLowerCase().includes('vendor')) {
                return 'vendor';
            }
            return 'customer';
        }

        // Render order tickets with enhanced features
        function renderTickets() {
            console.log('renderTickets called, orders count:', orders.length);
            
            const container = document.getElementById('tickets-container');
            const statusFilter = document.getElementById('status-filter').value;
            const searchFilter = document.getElementById('search-filter').value.toLowerCase();

            let filteredOrders = orders;

            // Apply status filter
            if (statusFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => {
                    const status = orderStatuses[order.orderId] || 'pending';
                    return status === statusFilter;
                });
            }

            // Apply search filter
            if (searchFilter) {
                filteredOrders = filteredOrders.filter(order => 
                    order.customer.toLowerCase().includes(searchFilter) ||
                    order.orderId.toString().includes(searchFilter) ||
                    order.phone.includes(searchFilter)
                );
            }

            console.log('Filtered orders count:', filteredOrders.length);

            if (filteredOrders.length === 0) {
                container.innerHTML = '<div class="no-orders">No orders match the current filters</div>';
                container.style.display = 'block';
                return;
            }

            // Show container and render tickets
            container.style.display = 'grid';
            document.getElementById('no-orders').style.display = 'none';
            
            container.innerHTML = filteredOrders.map(order => createTicketHTML(order)).join('');
            console.log('Tickets rendered successfully');
        }

        // Create HTML for a single ticket with enhanced features
        function createTicketHTML(order) {
            const status = orderStatuses[order.orderId] || 'pending';
            const statusClass = status === 'completed' ? 'completed' : status === 'in-progress' ? 'in-progress' : '';
            const isNewOrder = newOrderIds.has(order.orderId);

            const orderTime = new Date(order.timestamp).toLocaleString();

            const itemsHTML = Object.entries(order.items)
                .filter(([name, qty]) => qty > 0)
                .map(([name, qty]) => {
                    const displayName = getItemDisplayName(name);
                    const isCombo = name === 'combo';
                    return `
                        <div class="item ${isCombo ? 'combo' : ''}">
                            <span class="item-name">${displayName}</span>
                            <span class="item-qty">${qty}</span>
                        </div>
                    `;
                }).join('');

            let actionButtons = '';
            if (status === 'pending') {
                actionButtons = `<button class="btn btn-start" onclick="updateOrderStatus('${order.orderId}', 'in-progress')">Start Order</button>`;
            } else if (status === 'in-progress') {
                actionButtons = `<button class="btn btn-complete" onclick="updateOrderStatus('${order.orderId}', 'completed')">Mark Complete</button>`;
            } else {
                actionButtons = `<button class="btn btn-reset" onclick="updateOrderStatus('${order.orderId}', 'pending')">Reset</button>`;
            }

            return `
                <div class="ticket ${statusClass} ${isNewOrder ? 'new-order' : ''}" data-order-id="${order.orderId}">
                    <div class="ticket-header">
                        <div class="order-type-badge ${order.orderType}">
                            ${order.orderType === 'vendor' ? 'üè™ VENDOR' : 'üë§ CUSTOMER'}
                        </div>
                        <div class="order-info">
                            <div class="order-id">Order #${order.orderId}</div>
                            <div class="order-total">${order.total}</div>
                        </div>
                        <div class="customer-info">
                            <h3>${order.customer}</h3>
                            <div class="customer-details">
                                üì± ${order.phone}
                                ${order.email && order.email !== 'N/A' ? `<br>üìß ${order.email}` : ''}
                            </div>
                        </div>
                        <div class="timestamp">${orderTime}</div>
                    </div>
                    <div class="ticket-body">
                        <div class="order-items">
                            <h4>üìã Order Items</h4>
                            <div class="items-grid">
                                ${itemsHTML}
                            </div>
                        </div>
                        <div class="ticket-actions">
                            ${actionButtons}
                        </div>
                    </div>
                </div>
            `;
        }

        // Get display name for items
        function getItemDisplayName(itemName) {
            const names = {
                'chicharron': 'ü•ì Chicharr√≥n',
                'frijol': 'ü´ò Frijol con Longaniza',
                'papa': 'ü•î Carne con Papas',
                'combo': 'üéâ Taconmadre Combo',
                'water': 'üíß Water',
                'miniSoda': 'ü•§ Mini Soda',
                'seltzer': 'ü´ß Seltzer',
                'gatorade': '‚ö° Gatorade'
            };
            return names[itemName] || itemName;
        }

        // Update order status with enhanced feedback
        async function updateOrderStatus(orderId, newStatus) {
            orderStatuses[orderId] = newStatus;
            
            // Visual feedback
            const ticket = document.querySelector(`[data-order-id="${orderId}"]`);
            if (ticket) {
                ticket.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    ticket.style.transform = '';
                }, 200);
            }

            // If marking as completed, update the Google Sheet
            if (newStatus === 'completed') {
                await updateCompletedStatusInSheet(orderId);
            }

            renderTickets();
            updateStats();
        }

        // Update completed status in Google Sheet
        async function updateCompletedStatusInSheet(orderId) {
            try {
                // Find the row number for this order ID
                const orderIndex = orders.findIndex(order => order.orderId === orderId);
                if (orderIndex === -1) return;

                // Note: This would require additional Google Apps Script endpoint to update the sheet
                // For now, we'll just update the local state
                orders[orderIndex].completedInSheet = true;
                
                console.log(`Order ${orderId} marked as completed`);
            } catch (error) {
                console.error('Failed to update completion status in sheet:', error);
            }
        }

        // Reset all orders to pending
        function resetAllOrders() {
            if (confirm('Are you sure you want to reset all orders to pending status?')) {
                orderStatuses = {};
                renderTickets();
                updateStats();
                showNotification('All orders reset to pending status', 'success');
            }
        }

        // Filter orders based on selected criteria
        function filterOrders() {
            renderTickets();
        }

        // Update statistics with enhanced metrics
        function updateStats() {
            const total = orders.length;
            const pending = orders.filter(order => (orderStatuses[order.orderId] || 'pending') === 'pending').length;
            const inProgress = orders.filter(order => orderStatuses[order.orderId] === 'in-progress').length;
            const completed = orders.filter(order => orderStatuses[order.orderId] === 'completed').length;
            
            const revenue = orders.reduce((sum, order) => {
                const amount = parseFloat(order.total.replace('
            , '')) || 0;
                return sum + amount;
            }, 0);

            const newOrdersCount = newOrderIds.size;

            document.getElementById('total-orders').textContent = total;
            document.getElementById('pending-orders').textContent = pending;
            document.getElementById('in-progress-orders').textContent = inProgress;
            document.getElementById('completed-orders').textContent = completed;
            document.getElementById('total-revenue').textContent = `${revenue.toFixed(2)}`;
            document.getElementById('new-orders-count').textContent = newOrdersCount;
        }

        // Show notification for new orders with enhanced styling
        function showNewOrderNotification(count) {
            showNotification(`üîî ${count} New Order${count > 1 ? 's' : ''} Received!`, 'success');
        }

        // Initialize on page load
        updateStats();
    </script>
</body>
</html>
            